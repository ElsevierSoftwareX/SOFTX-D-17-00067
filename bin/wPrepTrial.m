function studyInfo=wPrepTrial(studyInfo,prepSStruct)
%   function studyInfo=wPrepTrial(studyInfo,prepSStruct)
%
%   This funtion generates the prepTrial script for study 
%   experiments created with the AudExpCreator.
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

line{1}='function prepTrial(wPtr, bgColor, fontColor)';
line{2}=sprintf('%% %s', line{1});
line{3}='% This function displays the prep screen and the prep screen text on the';
line{4}='% screen to help prepare the subject before the onset of the stim and the';
line{5}='% continuous behavioral rating task. To exit this prep screen press the';
line{6}=sprintf('%% %s key.',prepSStruct.exitB);
dLines=6;
line{dLines+1}='%';
line{dLines+2}='% This script was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dOS=5;

line{dOS+8}='KbName(''UnifyKeyNames'');';
line{dOS+9}=sprintf('spaceBar = KbName(''%s'');',prepSStruct.exitB);
line{dOS+10}=sprintf('escapeKey = KbName(''%s'');',studyInfo.fQuitKey);

line{dOS+12}=sprintf('tLine{1}=''%s'';',prepSStruct.text{1});
line{dOS+13}=sprintf('tLine{2}=''%s'';',prepSStruct.text{2});

line{dOS+15}='Screen(''FillRect'',wPtr,bgColor);';
line{dOS+16}='Screen(''TextSize'', wPtr, 18);';
line{dOS+17}='mytext = sprintf(''%s\n\n\n%s'',tLine{1},tLine{2});';
line{dOS+18}='[~, ~, ~] = DrawFormattedText(wPtr, mytext, ''center'', ''center'', fontColor);';
line{dOS+19}='Screen(wPtr, ''Flip'');';
line{dOS+20}='HideCursor;';

line{dOS+22}='onBreak=true;';
line{dOS+23}='while onBreak';
line{dOS+24}='[~, keyCode, ~] = KbWait([], 2);';
line{dOS+25}='if keyCode(spaceBar)';
line{dOS+26}='onBreak=false;';
line{dOS+27}='elseif keyCode(escapeKey)';
line{dOS+28}='clear all;';
line{dOS+29}='sca';
line{dOS+30}='end';
line{dOS+31}='end';

tabLine=[dOS+24:dOS+25 dOS+27 dOS+30];
dTabLine=[dOS+26 dOS+28:dOS+29];

studyInfo.fLine.pTrial = line{1}(10:end);

fName = 'prepTrial';
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);