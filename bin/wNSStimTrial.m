function studyInfo=wNSStimTrial(studyInfo)
%   function studyInfo=wNSStimTrial(studyInfo)
%
%   This funtion generates the stimTrial script for Neurophysiological
%   Study experiments.
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

stimSStruct=studyInfo.stimSStruct;

if strcmp(studyInfo.niReady,'Yes NI Device Ready')
    if strcmp(stimSStruct.type,'image')
        line{1}='function stimTrial(wPtr, wRect, bgColor, imdata, i, k, pahandle, freq,  wavdata, trigger, s)';
    else
        line{1}='function stimTrial(wPtr, wRect, bgColor, fontColor, i, k, pahandle, wavdata, freq, trigger, s)';
    end
elseif strcmp(studyInfo.niReady,'Not NI Device Ready')
    if strcmp(stimSStruct.type,'image')
        line{1}='function stimTrial(wPtr, wRect, bgColor, imdata, i, k, pahandle, freq,  wavdata, trigger)%, s)';
    else
        line{1}='function stimTrial(wPtr, wRect, bgColor, fontColor, i, k, pahandle, wavdata, freq, trigger)%, s)';
    end
else
    if strcmp(stimSStruct.type,'image')
        line{1}='function stimTrial(wPtr, wRect, bgColor, imdata, i, k, pahandle, freq,  wavdata, trigger)';
    else
        line{1}='function stimTrial(wPtr, wRect, bgColor, fontColor, i, k, pahandle, wavdata, freq, trigger)';
    end
end

if strcmp(stimSStruct.type,'image')
    line{4}='% The stim screen is a focus image to help subjects constrain eye movements.';
    dLines=4;
    line{dLines+1}='%';
    line{dLines+2}='% This script was generated by AudExpCreator.';
    line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
    line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
    line{dLines+5}='% Contact: audexpcreator@gmail.com';
    dOS=5;
    
    line{dOS+13}='imagetex=Screen(''MakeTexture'', wPtr, imdata);';
    line{dOS+14}='tRect=Screen(''Rect'', imagetex);';
    line{dOS+15}='CenterRect(tRect, wRect);';
    line{dOS+16}='Screen(''DrawTexture'',wPtr,imagetex);';
    
else
    if strcmp(stimSStruct.type,'cross')
        line{4}='% The stim screen is a small cross to help subjects constrain eye movements.';
        dLines=4;
        line{dLines+1}='%';
        line{dLines+2}='% This script was generated by AudExpCreator.';
        line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
        line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
        line{dLines+5}='% Contact: audexpcreator@gmail.com';
        dOS=5;
        
        line{dOS+13}='Screen(''DrawLine'',wPtr,fontColor, xC-30, yC, xC+30, yC, 2);';
        line{dOS+14}='Screen(''DrawLine'',wPtr,fontColor, xC, yC-30, xC, yC+30, 2);';
    elseif strcmp(stimSStruct.type,'dot')
        line{4}='% The stim screen is a small dot to help subjects constrain eye movements.';
        dLines=4;
        line{dLines+1}='%';
        line{dLines+2}='% This script was generated by AudExpCreator.';
        line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
        line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
        line{dLines+5}='% Contact: audexpcreator@gmail.com';
        dOS=5;
        
        line{dOS+13}='Screen(''FillOval'', wPtr, fontColor, [xC-25 yC-25 xC+25 yC+25]);';
    end
    
    line{dOS+8}='[xC, yC] = RectCenter(wRect);';
    
end

line{2}=sprintf('%% %s', line{1});
line{3}='% This function displays the stim screen and plays the stimulus.';

line{dOS+6}='PsychPortAudio(''FillBuffer'', pahandle, wavdata{i,k});';

line{dOS+9}='KbName(''UnifyKeyNames'');';
line{dOS+10}=sprintf('escapeKey = KbName(''%s'');',studyInfo.fQuitKey);

line{dOS+12}='Screen(''FillRect'', wPtr, bgColor);';
line{dOS+17}='Screen(wPtr, ''Flip'');';
line{dOS+18}='HideCursor;';
line{dOS+19}='duration = length(wavdata{i,k})/freq{i,k};';

if strcmp(studyInfo.niReady,'Yes NI Device Ready')
    line{dOS+21}='t=timer;';
    line{dOS+22}='t.StartDelay = 0;';
    line{dOS+23}='t.StartFcn = {@my_callback_fcn1,s,trigger{i,k}};';
    line{dOS+24}='t.TimerFcn = {@my_callback_fcn,pahandle};';
    
    line{dOS+26}='% PsychPortAudio(''Start'', pahandle, 1, 0, 0);';
    line{dOS+27}='start(t)';
    line{dOS+28}='tic';
    
    line{dOS+35}='clearDin(s);';
    line{dOS+36}='s.stop();';
    line{dOS+37}='release(s);';
elseif strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+21}='% t=timer;';
    line{dOS+22}='% t.StartDelay = 0;';
    line{dOS+23}='% t.StartFcn = {@my_callback_fcn1,s,trigger{i,k}};';
    line{dOS+24}='% t.TimerFcn = {@my_callback_fcn,pahandle};';
    
    line{dOS+26}='PsychPortAudio(''Start'', pahandle, 1, 0, 0);';
    line{dOS+27}='% start(t)';
    line{dOS+28}='tic';
    
    line{dOS+35}='% clearDin(s);';
    line{dOS+36}='% s.stop();';
    line{dOS+37}='% release(s);';
    
elseif strcmp(studyInfo.niReady,'Yes Ethernet Ready')
    line{dOS+21}='t=timer;';
    line{dOS+22}='t.StartDelay = 0;';
    line{dOS+23}='t.StartFcn = {@my_callback_fcn1,trigger{i}};';
    line{dOS+24}='t.TimerFcn = {@my_callback_fcn,pahandle};';
    
    line{dOS+26}='% PsychPortAudio(''Start'', pahandle, 1, 0, 0);';
    line{dOS+27}='start(t)';
    line{dOS+28}='tic';
elseif strcmp(studyInfo.niReady,'Not Ethernet Ready')
    line{dOS+21}='% t=timer;';
    line{dOS+22}='% t.StartDelay = 0;';
    line{dOS+23}='% t.StartFcn = {@my_callback_fcn1,trigger{i}};';
    line{dOS+24}='% t.TimerFcn = {@my_callback_fcn,pahandle};';
    
    line{dOS+26}='PsychPortAudio(''Start'', pahandle, 1, 0, 0);';
    line{dOS+27}='% start(t)';
    line{dOS+28}='tic';
end

line{dOS+29}='while toc < duration';
line{dOS+30}='[ keyIsDown, ~, keyCode ] = KbCheck;';
line{dOS+31}='if keyIsDown';
line{dOS+32}='if keyCode(escapeKey)';
line{dOS+33}='PsychPortAudio(''Stop'', pahandle);';
line{dOS+34}='PsychPortAudio(''Close'', pahandle);';

line{dOS+38}='sca;';
line{dOS+39}='clear all;';
line{dOS+40}='end';
line{dOS+41}='end';
line{dOS+42}='end';
line{dOS+43}='PsychPortAudio(''Stop'', pahandle, 1);';
line{dOS+44}='Screen(''Close'');';

tabLine=[dOS+30:dOS+31 dOS+41];
dTabLine=[dOS+32 dOS+40];
tTabLine=dOS+33:dOS+39;

studyInfo.fLine.sTrial = line{1}(10:end);

fName = 'stimTrial';
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    elseif any(ismember(i,tTabLine))
        fprintf(fID,'\t\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);







