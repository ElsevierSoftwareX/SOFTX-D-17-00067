function studyInfo=wBeRaMainExp(studyInfo)
%   function studyInfo=wBeRaMainExp(studyInfo)
%
%   This funtion generates the main experiment script for Behavioral Rating
%   Study experiments. 
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

blankStruct=studyInfo.blankStruct;

line{1}=sprintf('function %sExp', studyInfo.name);
line{2}=sprintf('%% function %sExp', studyInfo.name);

desc=cellstr(studyInfo.desc);
dLines=size(desc,1);
for i=1:dLines
    line{i+2}=sprintf('%% %s',desc{i});
end
line{dLines+1}='%';
line{dLines+2}='% This study experiment was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dLines=dLines+5;
dOS=3+dLines;


line{dOS+1}='todayDate = input(''What is today''''s date (yyyymmdd)?   '');';

line{dOS+3}='subject = input(''Which subject is this?   '');';
line{dOS+4}=sprintf('if subject > %g',studyInfo.subNum);
line{dOS+5}='disp(sprintf(''\nYou''''ve put in a subject num that exceeds the number of subjects in your''));';
line{dOS+6}=sprintf('disp(sprintf(''stimulus array. Please input a subject num of %g or less.''));', studyInfo.subNum');
line{dOS+7}='return;';
line{dOS+8}='end';
tabLine=dOS+5:dOS+6;
dTabLine=[];
dOS=dOS+9;

if studyInfo.presNum > 1
    line{dOS+1}='whichPres = input(''Which round of stimulus presentation is this?   '');';
    line{dOS+2}=sprintf('if whichPres > %g',studyInfo.presNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a number that exceeds the number of presentations in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a number of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end
if studyInfo.recNum > 1
    line{dOS+1}='whichRec = input(''Which recording is this?   '');';
    line{dOS+2}=sprintf('if whichRec > %g',studyInfo.recNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a recording num that exceeds the number of recordings in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a recording num of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end

line{dOS+1}=sprintf('%s;',studyInfo.fLine.buildSWS);
line{dOS+2}='try';
line{dOS+3}=sprintf('load(''%s.mat'');',studyInfo.qStructName);
line{dOS+4}='catch';
line{dOS+5}=sprintf(['disp(sprintf(''\\nYour question structure is missing.\\nTry',...
    ' updating your study to get the question structure back.''));']);
line{dOS+6}='error(''The experimental study was terminated.'');';
line{dOS+7}='end';
tabLine=[tabLine dOS+3 dOS+5:dOS+6];
dOS=dOS+8;

line{dOS+1}='screenNum = 0;';
line{dOS+2}=sprintf('res=[%g %g];',studyInfo.res(:));
line{dOS+3}='clrdepth=32;';
line{dOS+4}=sprintf('bgColor=[%g %g %g];',studyInfo.bgColor(:));
line{dOS+5}=sprintf('fontColor=[%g %g %g];',studyInfo.fontColor(:));
line{dOS+6}='[wPtr,wRect]=Screen(''OpenWindow'',screenNum,1,...';
line{dOS+7}='[0 0 res(1) res(2)], clrdepth);';

line{dOS+9}='InitializePsychSound(1);';
line{dOS+10}='pahandle = PsychPortAudio(''Open'', [], [], 0, freq{1}, nrchannels{1}, [], .050);';
dOS=dOS+11;

line{dOS+1}='c=1;';
dOS=dOS+2;

if strcmp(studyInfo.beRaInfo.breakSOpts,'No "Break" Screen')
    line{dOS+1}=sprintf('%s;',studyInfo.fLine.rTrial);
    line{dOS+2}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',blankStruct.duration(2));
    dOS=dOS+3;
else
    line{dOS+1}=sprintf('%s;',studyInfo.fLine.rTrial);
    line{dOS+2}=sprintf('%s;',studyInfo.fLine.bTrial);
    line{dOS+3}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',blankStruct.duration(2));
    dOS=dOS+4;
end

line{dOS+1}='for i=1:length(wavdata)';
line{dOS+2}=sprintf('%s;',studyInfo.fLine.sTrial);
tabLine=[tabLine dOS+2];
dOS=dOS+2;

line{dOS+1}=sprintf('if mod(i,%g)==0',studyInfo.stimInSet);
line{dOS+2}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',blankStruct.duration(1));
line{dOS+3}=sprintf('trigIndex=find([%s.trigger]==trigger{i});',studyInfo.qStructName);
line{dOS+4}=sprintf('rData(c).trigger=[trigger{i-%g:i}];', studyInfo.stimInSet-1);
line{dOS+5}=sprintf('qNum=%s(trigIndex).qNum;',studyInfo.qStructName);
line{dOS+6}='for q=1:qNum';
line{dOS+7}=sprintf('%s;',studyInfo.fLine.qTrial);
line{dOS+8}=sprintf('rData(c).question{q}=%s(trigIndex).question{q};',studyInfo.qStructName);
line{dOS+9}='rData(c).response{q}=res;';
line{dOS+10}='rData(c).responseTime{q}=rTime;';
line{dOS+11}='end';
line{dOS+12}='c=c+1;';
tabLine=[tabLine dOS+1];
dTabLine=[dTabLine dOS+2:dOS+6 dOS+11:dOS+12];
tTabLine=dOS+7:dOS+10;
dOS=dOS+12;

if strcmp(studyInfo.beRaInfo.breakSOpts,'No "Break" Screen')
    line{dOS+1}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',blankStruct.duration(2));
    dTabLine=[dTabLine dOS+1];
    dOS=dOS+1;
else
    line{dOS+1}='if i<length(wavdata)';
    line{dOS+2}=sprintf('%s;',studyInfo.fLine.bTrial);
    line{dOS+3}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',blankStruct.duration(2));
    line{dOS+4}='end';
    dTabLine=[dTabLine dOS+1 dOS+4];
    tTabLine=[tTabLine dOS+2:dOS+3];
    dOS=dOS+4;
end

line{dOS+1}='end';
line{dOS+2}='end';
tabLine=[tabLine dOS+1];

line{dOS+4}=sprintf('%s;',studyInfo.fLine.eTrial);
line{dOS+5}='Screen(''CloseAll'');';
line{dOS+6}='ShowCursor;';
dOS=dOS+7;

line{dOS+1}=sprintf('path=which(''%sExp'');',studyInfo.name);
line{dOS+2}='i=find(filesep==path);';
line{dOS+3}='path=path(1:i(end));';
line{dOS+4}='dataPath=[path ''data'' filesep];';
dOS=dOS+5;

if studyInfo.presNum>1 && studyInfo.recNum>1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_R%%02d_%%d_BR'', subject, whichPres, whichRec, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum>1 && studyInfo.recNum==1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_%%d_BR'', subject, whichPres, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum==1 && studyInfo.recNum>1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_R%%02d_%%d_BR'', subject, whichRec, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum==1 && studyInfo.recNum==1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_%%d_BR'', subject, todayDate);',studyInfo.name);
    dOS=dOS+2;
end
    
line{dOS+1}='dataName = [dataPath name];';
line{dOS+2}='save(dataName, ''rData'');'; 

studyInfo=wWriteExpLog(studyInfo);

line{dOS+4}=sprintf('%s',studyInfo.fLine.wExpLog);
line{dOS+6}='clear all;';

studyInfo.fLine.mainExp = line{1}(10:end);

fName = sprintf('%sExp', studyInfo.name);
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    elseif any(ismember(i,tTabLine))
        fprintf(fID,'\t\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);

