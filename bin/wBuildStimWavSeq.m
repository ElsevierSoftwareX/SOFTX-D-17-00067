function studyInfo=wBuildStimWavSeq(studyInfo)
%   function studyInfo=wBuildStimWavSeq(studyInfo)
%
%   This funtion generates the buildStimWavSeq script for study experiments
%   created with the AudExpCreator.
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

line{3}='% This function loads the stimulus stucture and the stimulus array in order';
line{4}='% to read and prepare the auditory stimulus files into a matrix that will be';
line{5}='% used in the session.';
dLines=5;
line{dLines+1}='%';
line{dLines+2}='% This script was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dOS=5;

if studyInfo.recNum > 1
    yesRec = 1;
else
    yesRec = 0;
end

if studyInfo.presNum > 1
    yesPres = 1;
else
    yesPres = 0;
end

if yesPres==1 && yesRec==1
    line{1}='function [freq, wavdata, nrchannels, trigger] = buildStimWavSeq(subject, whichRec, whichPres)';
    line{dOS+25}=sprintf('stim=%s{whichPres}(subject,:,whichRec);',studyInfo.stimArrayName);
elseif yesPres==1 && yesRec==0
    line{1}='function [freq, wavdata, nrchannels, trigger] = buildStimWavSeq(subject, whichPres)';
    line{dOS+25}=sprintf('stim=%s{whichPres}(subject,:);',studyInfo.stimArrayName);
elseif yesPres==0 && yesRec==1
    line{1}='function [freq, wavdata, nrchannels, trigger] = buildStimWavSeq(subject, whichRec)';
    line{dOS+25}=sprintf('stim=%s(subject,:,whichRec);',studyInfo.stimArrayName);
elseif yesPres==0 && yesRec==0
    line{1}='function [freq, wavdata, nrchannels, trigger] = buildStimWavSeq(subject)';
    line{dOS+25}=sprintf('stim=%s(subject,:);',studyInfo.stimArrayName);
end

line{2}=sprintf('%% %s', line{1});

line{dOS+7}='path=which(''buildStimWavSeq'');';
line{dOS+8}='i=find(filesep==path);';
line{dOS+9}='path=path(1:i(end));';
line{dOS+11}='try';
line{dOS+12}=sprintf('load([path ''%s.mat'']);',studyInfo.stimStructName);
line{dOS+13}='catch';
line{dOS+14}=sprintf(['disp(sprintf(''\\nYour stimulus structure is missing.\\nTry',...
    ' updating your study to get the stimulus structure back.''));']);
line{dOS+15}='error(''The experimental study was terminated.'');';
line{dOS+16}='end';
line{dOS+18}='try';
line{dOS+19}=sprintf('load([path ''%s.mat'']);',studyInfo.stimArrayName);
line{dOS+20}='catch';
line{dOS+21}=sprintf(['disp(sprintf(''\\nYour stimulus array is missing.\\nTry',...
    ' updating your study to get the stimulus array back.''));']);
line{dOS+22}='error(''The experimental study was terminated.'');';
line{dOS+23}='end';
tabLine=[dOS+12 dOS+14:dOS+15 dOS+19 dOS+21:dOS+22];
tTabLine=[];
subL=dOS+26;

if strcmp(studyInfo.type,'Neurophysiological Study')
    line{subL+1}=sprintf('aSet=%d;',studyInfo.bLSettings);
    line{subL+2}='setNum=length(stim)/aSet;';
    line{subL+3}='A=[];';
    line{subL+4}='for i=1:aSet:length(stim)';
    line{subL+5}='A=[A 1 stim(i:i+(aSet-1))];';
    line{subL+6}='end';
    line{subL+7}='stim=reshape(A,[1,length(A)/setNum,setNum]);';
    tabLine=[tabLine subL+5];
    subL=subL+8;
    
    line{subL+1}='try';
    line{subL+2}='for i=1:size(stim,3)';
    line{subL+3}='for k=1:size(stim,2)';
    line{subL+4}=sprintf('[y{i,k}, freq{i,k}] = audioread(%s(stim(1,k,i)).file);',studyInfo.stimStructName);
    line{subL+5}=sprintf('trigger{i,k}= %s(stim(1,k,i)).trigger;',studyInfo.stimStructName);
    line{subL+6}='wavdata{i,k} = y{i,k}'';';
    line{subL+7}='nrchannels{i,k} = size(wavdata{i,k},1);';
    line{subL+8}='end';
    line{subL+9}='end';
    line{subL+10}='catch';
    line{subL+11}=sprintf(['disp(sprintf([''\\nSomething went wrong.\\nTry checking the stimuli in',...
        ' the stimulus folder,\\nor '',...']);
    line{subL+12}=sprintf('''try updating your study to get the correct stimulus structure or array.'']));');
    line{subL+13}='error(''The experimental study was terminated.'');';
    line{subL+14}='end';
    tabLine=[tabLine subL+2 subL+9 subL+11:subL+13];
    dTabLine=[subL+3 subL+8];
    tTabLine=[tTabLine subL+4:subL+7];
elseif strcmp(studyInfo.type,'Comparison Behav. Rating Study')
    line{subL+1}=sprintf('aSet=%d;',studyInfo.stimInSet);
    line{subL+2}='setNum=length(stim)/aSet;';
    line{subL+3}='stim=reshape(stim,[1,aSet,setNum]);';
    subL=subL+4;
    
    line{subL+1}='try';
    line{subL+2}='for i=1:size(stim,3)';
    line{subL+3}='for k=1:size(stim,2)';
    line{subL+4}=sprintf('[y{i,k}, freq{i,k}] = audioread(%s(stim(1,k,i)).file);',studyInfo.stimStructName);
    line{subL+5}=sprintf('trigger{i,k}= %s(stim(1,k,i)).trigger;',studyInfo.stimStructName);
    line{subL+6}='wavdata{i,k} = y{i,k}'';';
    line{subL+7}='nrchannels{i,k} = size(wavdata{i,k},1);';
    line{subL+8}='end';
    line{subL+9}='end';
    line{subL+10}='catch';
    line{subL+11}=sprintf(['disp(sprintf([''\\nSomething went wrong.\\nTry checking the stimuli in',...
        ' the stimulus folder,\\nor '',...']);
    line{subL+12}=sprintf('''try updating your study to get the correct stimulus structure or array.'']));');
    line{subL+13}='error(''The experimental study was terminated.'');';
    line{subL+14}='end';
    tabLine=[tabLine subL+2 subL+9 subL+11:subL+13];
    dTabLine=[subL+3 subL+8];
    tTabLine=[tTabLine subL+4:subL+7];
else
    line{subL+1}='try';
    line{subL+2}='for i=1:length(stim)';
    line{subL+3}=sprintf('[y{i}, freq{i}] = audioread(%s(stim(i)).file);',studyInfo.stimStructName);
    line{subL+4}=sprintf('trigger{i}= %s(stim(i)).trigger;',studyInfo.stimStructName);
    line{subL+5}='wavdata{i} = y{i}'';';
    line{subL+6}='nrchannels{i} = size(wavdata{i},1);';
    line{subL+7}='end';
    line{subL+8}='catch';
    line{subL+9}=sprintf(['disp(sprintf([''\\nSomething went wrong.\\nTry checking the stimuli in',...
        ' the stimulus folder,\\nor '',...']);
    line{subL+10}=sprintf('''try updating your study to get the correct stimulus structure or array.'']));');
    line{subL+11}='error(''The experimental study was terminated.'');';
    line{subL+12}='end';
    tabLine=[tabLine subL+2 subL+7 subL+9:subL+11];
    dTabLine=subL+3:subL+6;
end

studyInfo.fLine.buildSWS = line{1}(10:end);

fName = 'buildStimWavSeq';
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    elseif any(ismember(i,tTabLine))
        fprintf(fID,'\t\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);