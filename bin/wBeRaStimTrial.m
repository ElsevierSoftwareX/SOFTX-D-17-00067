function studyInfo=wBeRaStimTrial(studyInfo,stimSStruct)
%   function studyInfo=wBeRaStimTrial(studyInfo,stimSStruct)
%
%   This funtion generates the stimTrial script for Behavioral Rating
%   Study experiments. 
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

line{1}='function stimTrial(wPtr, bgColor, fontColor, i, wavdata, freq, pahandle)';
line{2}=sprintf('%% %s', line{1});
line{3}='% This function displays the stim screen and plays the stimulus.'; 
dLines=3;
line{dLines+1}='%';
line{dLines+2}='% This script was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dOS=5;

line{dOS+5}='PsychPortAudio(''FillBuffer'', pahandle, wavdata{i});';
line{dOS+6}='KbName(''UnifyKeyNames'');';
line{dOS+7}='duration = length(wavdata{i})/freq{i};';
line{dOS+8}='Screen(''FillRect'',wPtr,bgColor);';
line{dOS+9}='Screen(''TextSize'', wPtr, 45);';
line{dOS+10}=sprintf('mytext = ''%s'';',stimSStruct.text);
line{dOS+11}='[~, ~, ~] = DrawFormattedText(wPtr, mytext, ''center'', ''center'', fontColor);';
line{dOS+12}='Screen(''Flip'', wPtr);';
line{dOS+13}='HideCursor;';
line{dOS+15}='tic';
line{dOS+16}='while toc<1';
line{dOS+17}='end';
line{dOS+19}='PsychPortAudio(''Start'', pahandle, 1, 0, 0);';
line{dOS+20}='tic;';
line{dOS+21}='while toc < duration';
line{dOS+22}='[~, ~, keyCode] = KbCheck;';
line{dOS+23}=sprintf('if keyCode(KbName(''%s''))',studyInfo.fQuitKey);
line{dOS+24}='PsychPortAudio(''Stop'', pahandle);';
line{dOS+25}='sca;';
line{dOS+26}='clear all;';
line{dOS+27}='end';
line{dOS+28}='end';
line{dOS+29}='PsychPortAudio(''Stop'', pahandle);';
line{dOS+30}='Screen (''Close'');';

tabLine=[dOS+22:dOS+23 dOS+27];
dTabLine=dOS+25:dOS+26;

studyInfo.fLine.sTrial = line{1}(10:end);

fName = 'stimTrial';
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);


