function studyInfo=wNSMainExp(studyInfo)
%   function studyInfo=wNSMainExp(studyInfo)
%
%   This funtion generates the main experiment script for
%   Neurophysiological Study experiments
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

stimSStruct=studyInfo.stimSStruct;
blankStruct=studyInfo.blankStruct;

line{1}=sprintf('function %sExp', studyInfo.name);
line{2}=sprintf('%% function %sExp', studyInfo.name);

desc=cellstr(studyInfo.desc);
dLines=size(desc,1);
for i=1:dLines
    line{i+2}=sprintf('%% %s',desc{i});
end
line{dLines+1}='%';
line{dLines+2}='% This study experiment was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dLines=dLines+5;
dOS=3+dLines;

tabLine=[];
dTabLine=[];

if strcmp(studyInfo.niReady,'Yes NI Device Ready')
    line{dOS+1}='s = startNIDevice;';
    dOS=dOS+2;
elseif strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+1}='% s = startNIDevice;';
    dOS=dOS+2;
elseif strcmp(studyInfo.niReady,'Yes Ethernet Ready')
    line{dOS+1}='try';
    line{dOS+2}='load(''NetSInfo.mat'');';
    line{dOS+3}='catch';
    line{dOS+4}='NetSInfo.host = input(''What is the ip address of NetStation?    '',''s'');';
    line{dOS+5}='NetSInfo.port = input(''What is TCP/IP Port of NetStation?   '');';
    line{dOS+6}='yesSave = input(''Would you like to save that information for future runs? (yes/no)    '',''s'');';
    line{dOS+7}='if strcmpi(yesSave,''yes'')';
    line{dOS+8}='save NetSInfo.mat NetSInfo';
    line{dOS+9}='else';
    line{dOS+10}='display(''NetStation information was not saved. You will have to re-enter for next run.'');';
    line{dOS+11}='end';
    line{dOS+12}='end';

    line{dOS+14}='[status, erMS] = NetStation(''Connect'', NetSInfo.host, NetSInfo.port);';
    line{dOS+15}='if status~=0';
    line{dOS+16}='display([erMS ''. Goodbye.''])';
    line{dOS+17}='error(''Failure to communicate with NetStation.'');';
    line{dOS+18}='else';
    line{dOS+19}='display(''Connection to NetStation was successful.'');';
    line{dOS+20}='end';

    line{dOS+22}='[status, erMS] = NetStation(''Synchronize'');';
    line{dOS+23}='if status~=0';
    line{dOS+24}='display([erMS ''. Goodbye.''])';
    line{dOS+25}='error(''Failure to synchronize with NetStation.'');';
    line{dOS+26}='else';
    line{dOS+27}='display(''Synchronization to NetStation was successful.'');';
    line{dOS+28}='end';
    tabLine=[dOS+2 dOS+4:dOS+7 dOS+9 dOS+11 dOS+16:dOS+17 dOS+19 dOS+24:dOS+25 dOS+27];
    dTabLine=[dOS+8 dOS+10];
    dOS=dOS+29;
    
elseif strcmp(studyInfo.niReady,'Not Ethernet Ready')
    line{dOS+1}='% try';
    line{dOS+2}='% load(''NetSInfo.mat'');';
    line{dOS+3}='% catch';
    line{dOS+4}='% NetSInfo.host = input(''What is the ip address of NetStation?    '',''s'');';
    line{dOS+5}='% NetSInfo.port = input(''What is TCP/IP Port of NetStation?   '');';
    line{dOS+6}='% yesSave = input(''Would you like to save that information for future runs? (yes/no)    '',''s'');';
    line{dOS+7}='% if strcmpi(yesSave,''yes'')';
    line{dOS+8}='% save NetSInfo.mat NetSInfo';
    line{dOS+9}='% else';
    line{dOS+10}='% display(''NetStation information was not saved. You will have to re-enter for next run.'');';
    line{dOS+11}='% end';
    line{dOS+12}='% end';
    
    line{dOS+14}='% [status, erMS] = NetStation(''Connect'', NetSInfo.host, NetSInfo.port);';
    line{dOS+15}='% if status~=0';
    line{dOS+16}='% display([erMS ''. Goodbye.''])';
    line{dOS+17}='% error(''Failure to communicate with NetStation.'');';
    line{dOS+18}='% else';
    line{dOS+19}='% display(''Connection to NetStation was successful.'');';
    line{dOS+20}='% end';
    
    line{dOS+22}='% [status, erMS] = NetStation(''Synchronize'');';
    line{dOS+23}='% if status~=0';
    line{dOS+24}='% display([erMS ''. Goodbye.''])';
    line{dOS+25}='% error(''Failure to synchronize with NetStation.'');';
    line{dOS+26}='% else';
    line{dOS+27}='% display(''Synchronization to NetStation was successful.'');';
    line{dOS+28}='% end';
    tabLine=[dOS+2 dOS+4:dOS+7 dOS+9 dOS+11 dOS+16:dOS+17 dOS+19 dOS+24:dOS+25 dOS+27];
    dTabLine=[dOS+8 dOS+10];
    dOS=dOS+29;
end

line{dOS+1}='todayDate = input(''What is today''''s date (yyyymmdd)?   '');';

line{dOS+3}='subject = input(''Which subject is this?   '');';
line{dOS+4}=sprintf('if subject > %g',studyInfo.subNum);
line{dOS+5}='disp(sprintf(''\nYou''''ve put in a subject num that exceeds the number of subjects in your''));';
line{dOS+6}=sprintf('disp(sprintf(''stimulus array. Please input a subject num of %g or less.''));', studyInfo.subNum');
line{dOS+7}='return;';
line{dOS+8}='end';
tabLine=[tabLine dOS+5:dOS+6];
dOS=dOS+9;

if studyInfo.presNum > 1
    line{dOS+1}='whichPres = input(''Which round of stimulus presentation is this?   '');';
    line{dOS+2}=sprintf('if whichPres > %g',studyInfo.presNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a number that exceeds the number of presentations in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a number of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end
if studyInfo.recNum > 1
    line{dOS+1}='whichRec = input(''Which recording is this?   '');';
    line{dOS+2}=sprintf('if whichRec > %g',studyInfo.recNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a recording num that exceeds the number of recordings in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a recording num of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end

line{dOS+1}=sprintf('%s;',studyInfo.fLine.buildSWS);
dOS=dOS+2;

line{dOS+1}=sprintf('path=which(''%sExp'');',studyInfo.name);
line{dOS+2}='i=find(filesep==path);';
line{dOS+3}='path=path(1:i(end));';
dOS=dOS+4;

if strcmp(stimSStruct.type,'image')
    line{dOS+1}=sprintf('myimgfile = [ path ''stimulus'' filesep ''%s''];',stimSStruct.name);
    line{dOS+2}='try';
    line{dOS+3}='imdata=imread(myimgfile, ''jpeg'');';
    line{dOS+4}='catch';
    line{dOS+5}=sprintf(['disp(sprintf(''\\nYour focus image is missing.\\nTry',...
        ' updating your study to upload another focus image.''));']);
    line{dOS+6}='error(''The experimental study was terminated.'');';
    line{dOS+7}='end';
    tabLine=[tabLine dOS+3 dOS+5:dOS+6];
    dOS=dOS+8;
end

if strcmp(studyInfo.nSInfo.questOpts,'No question(s)')
else
    line{dOS+1}='try';
    line{dOS+2}=sprintf('load(''%s.mat'');',studyInfo.qStructName);
    line{dOS+3}='catch';
    line{dOS+4}=sprintf(['disp(sprintf(''\\nYour question structure is missing.\\nTry',...
        ' updating your study to get the question structure back.''));']);
    line{dOS+5}='error(''The experimental study was terminated.'');';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+2 dOS+4:dOS+5];
    dOS=dOS+7;
end

if strcmp(studyInfo.niReady,'Yes NI Device Ready')
    line{dOS+1}='s = startNIDevice;';
    dOS=dOS+2;
elseif strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+1}='% s = startNIDevice;';
    dOS=dOS+2;
end

line{dOS+1}='screenNum = 0;';
line{dOS+2}=sprintf('res=[%g %g];',studyInfo.res(:));
line{dOS+3}='clrdepth=32;';
line{dOS+4}=sprintf('bgColor=[%g %g %g];',studyInfo.bgColor(:));
line{dOS+5}=sprintf('fontColor=[%g %g %g];',studyInfo.fontColor(:));
line{dOS+6}='[wPtr,wRect]=Screen(''OpenWindow'',screenNum,1,...';
line{dOS+7}='[0 0 res(1) res(2)], clrdepth);';

line{dOS+9}='InitializePsychSound(1);';
line{dOS+10}='pahandle = PsychPortAudio(''Open'', [], [], 0, freq{1}, nrchannels{1}, [], .050);';
dOS=dOS+11;

if strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+1}=sprintf('%s;%%, s)',studyInfo.fLine.rTrial(1:end-5));
else
    line{dOS+1}=sprintf('%s;',studyInfo.fLine.rTrial);
end
dOS=dOS+2;

line{dOS+1}='for i=1:size(wavdata,1)';
if strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+2}=sprintf('%s;%%, s)',studyInfo.fLine.bTrial(1:end-5));
else
    line{dOS+2}=sprintf('%s;',studyInfo.fLine.bTrial);
end
if strcmp(blankStruct.type,'image')
    line{dOS+3}=sprintf('blankTrial(wPtr, wRect, bgColor, imdata, %g);',studyInfo.blankStruct.duration(2));
else
    line{dOS+3}=sprintf('blankTrial(wPtr, wRect, bgColor, fontColor, %g);',studyInfo.blankStruct.duration(2));
end
tabLine=[tabLine dOS+2:dOS+3];
dOS=dOS+3;

line{dOS+1}='for k=1:size(wavdata,2)';
if strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+2}=sprintf('%s;%%, s)',studyInfo.fLine.sTrial(1:end-5));
else
    line{dOS+2}=sprintf('%s;',studyInfo.fLine.sTrial);
end
line{dOS+3}='if k==1';
if strcmp(blankStruct.type,'image')
    line{dOS+4}=sprintf('blankTrial(wPtr, wRect, bgColor, imdata, %g);',studyInfo.blankStruct.duration(1));
else
    line{dOS+4}=sprintf('blankTrial(wPtr, wRect, bgColor, fontColor, %g);',studyInfo.blankStruct.duration(1));
end
line{dOS+5}='end';
line{dOS+6}='end';
tabLine=[tabLine dOS+1 dOS+6];
dTabLine=[dTabLine dOS+2:dOS+3 dOS+5];
tTabLine=dOS+4;
dOS=dOS+7;

if strcmp(studyInfo.nSInfo.questOpts,'No question(s)')
else
    if studyInfo.yesData
        line{dOS+1}=sprintf('trigIndex=find([%s.trigger]==trigger{i,k});',studyInfo.qStructName);
        line{dOS+2}='rData(i).trigger=[trigger{i,:}];';
        line{dOS+3}=sprintf('qNum=%s(trigIndex).qNum;',studyInfo.qStructName);
        line{dOS+4}='for q=1:qNum';
        if strcmp(studyInfo.niReady,'Not NI Device Ready')
            line{dOS+5}=sprintf('%s;%%, s)',studyInfo.fLine.qTrial(1:end-5));
        else
            line{dOS+5}=sprintf('%s;',studyInfo.fLine.qTrial);
        end
        line{dOS+6}=sprintf('rData(i).question{q}=%s(trigIndex).question{q};',studyInfo.qStructName);
        line{dOS+7}='rData(i).response{q}=res;';
        line{dOS+8}='rData(i).responseTime{q}=rTime;';
        line{dOS+9}='end';
        tabLine=[tabLine dOS+1:dOS+4 dOS+9];
        dTabLine=[dTabLine dOS+5:dOS+8];
        dOS=dOS+9;
    else
        line{dOS+1}=sprintf('trigIndex=find([%s.trigger]==trigger{i,k});',studyInfo.qStructName);
        line{dOS+2}=sprintf('qNum=%s(trigIndex).qNum;',studyInfo.qStructName);
        line{dOS+3}='for q=1:qNum';
        if strcmp(studyInfo.niReady,'Not NI Device Ready')
            line{dOS+4}=sprintf('%s;%%, s)',studyInfo.fLine.qTrial(1:end-5));
        else
            line{dOS+4}=sprintf('%s;',studyInfo.fLine.qTrial);
        end
        line{dOS+5}='end';
        tabLine=[tabLine dOS+1:dOS+3 dOS+5];
        dTabLine=[dTabLine dOS+4];
        dOS=dOS+5;
    end
end

line{dOS+1}='end';

if strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+3}=sprintf('%s;%%, s)',studyInfo.fLine.eTrial(1:end-5));
else
    line{dOS+3}=sprintf('%s;',studyInfo.fLine.eTrial);
end

if strcmp(studyInfo.niReady,'Yes NI Device Ready')
    line{dOS+4}='clearDin(s);';
    line{dOS+5}='s.stop();';
    line{dOS+6}='release(s);';
elseif strcmp(studyInfo.niReady,'Not NI Device Ready')
    line{dOS+4}='% clearDin(s);';
    line{dOS+5}='% s.stop();';
    line{dOS+6}='% release(s);';
end
line{dOS+7}='Screen(''CloseAll'');';
line{dOS+8}='ShowCursor;';
dOS=dOS+9;

if studyInfo.yesData
    line{dOS+1}='dataPath=[path ''data'' filesep];';
    dOS=dOS+1;
    
    if studyInfo.presNum>1 && studyInfo.recNum>1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_R%%02d_%%d_NS'', subject, whichPres, whichRec, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum>1 && studyInfo.recNum==1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_%%d_NS'', subject, whichPres, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum==1 && studyInfo.recNum>1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_R%%02d_%%d_NS'', subject, whichRec, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum==1 && studyInfo.recNum==1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_%%d_NS'', subject, todayDate);',studyInfo.name);
        dOS=dOS+2;
    end
    
    line{dOS+1}='dataName = [dataPath name];';
    line{dOS+2}='save(dataName, ''rData'');';
    dOS=dOS+3;
end


studyInfo=wWriteExpLog(studyInfo);

line{dOS+1}=sprintf('%s;',studyInfo.fLine.wExpLog);

line{dOS+3}='clear all;';


studyInfo.fLine.mainExp = line{1}(10:end);

fName = sprintf('%sExp', studyInfo.name);
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    elseif any(ismember(i,tTabLine))
        fprintf(fID,'\t\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);
























