function studyInfo=wCoBeMainExp(studyInfo)
%   function studyInfo=wCoBeMainExp(studyInfo)
%
%   This funtion generates the main experiment script for Continuous 
%    Behavioral Rating Study experiments. 
%
% (c) Duc T. Nguyen and Blair Kaneshiro, 2017
% Distributed under Creative Commons Zero (CC0) license
% Contact: audexpcreator@gmail.com

line{1}=sprintf('function %sExp', studyInfo.name);
line{2}=sprintf('%% function %sExp', studyInfo.name);

desc=cellstr(studyInfo.desc);
dLines=size(desc,1);
for i=1:dLines
    line{i+2}=sprintf('%% %s',desc{i});
end
line{dLines+1}='%';
line{dLines+2}='% This study experiment was generated by AudExpCreator.';
line{dLines+3}='% (c) Duc T. Nguyen and Blair Kaneshiro, 2017';
line{dLines+4}='% Distributed under Creative Commons Zero (CC0) license';
line{dLines+5}='% Contact: audexpcreator@gmail.com';
dLines=dLines+5;
dOS=3+dLines;

line{dOS+1}='todayDate = input(''What is today''''s date (yyyymmdd)?   '');';

line{dOS+3}='subject = input(''Which subject is this?   '');';
line{dOS+4}=sprintf('if subject > %g',studyInfo.subNum);
line{dOS+5}='disp(sprintf(''\nYou''''ve put in a subject num that exceeds the number of subjects in your''));';
line{dOS+6}=sprintf('disp(sprintf(''stimulus array. Please input a subject num of %g or less.''));', studyInfo.subNum');
line{dOS+7}='return;';
line{dOS+8}='end';
tabLine=dOS+5:dOS+6;
dTabLine=[];
dOS=dOS+9;

if studyInfo.presNum > 1
    line{dOS+1}='whichPres = input(''Which round of stimulus presentation is this?   '');';
    line{dOS+2}=sprintf('if whichPres > %g',studyInfo.presNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a number that exceeds the number of presentations in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a number of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end
if studyInfo.recNum > 1
    line{dOS+1}='whichRec = input(''Which recording is this?   '');';
    line{dOS+2}=sprintf('if whichRec > %g',studyInfo.recNum);
    line{dOS+3}='disp(sprintf(''\nYou''''ve put in a recording num that exceeds the number of recordings in your''));';
    line{dOS+4}=sprintf('disp(sprintf(''stimulus array. Please input a recording num of %g or less.''));', studyInfo.presNum');
    line{dOS+5}='return;';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+3:dOS+5];
    dOS=dOS+7;
end

line{dOS+1}=sprintf('%s;',studyInfo.fLine.buildSWS);
line{dOS+2}='try';
line{dOS+3}=sprintf('load(''%s.mat'');',studyInfo.insStructName);
line{dOS+4}='catch';
line{dOS+5}=sprintf(['disp(sprintf(''\\nYour stim instruction structure is missing.\\nTry',...
    ' updating your study to get the instruction structure back.''));']);
line{dOS+6}='error(''The experimental study was terminated.'');';
line{dOS+7}='end';
tabLine=[tabLine dOS+3 dOS+5:dOS+6];
dOS=dOS+8;

if strcmp(studyInfo.coBeInfo.questOpts,'No end question(s)')
else
    line{dOS+1}='try';
    line{dOS+2}=sprintf('load(''%s.mat'');',studyInfo.qStructName);
    line{dOS+3}='catch';
    line{dOS+4}=sprintf(['disp(sprintf(''\\nYour stim question structure is missing.\\nTry',...
        ' updating your study to get the question structure back.''));']);
    line{dOS+5}='error(''The experimental study was terminated.'');';
    line{dOS+6}='end';
    tabLine=[tabLine dOS+2 dOS+4:dOS+5];
    dOS=dOS+7;
end

line{dOS+1}='screenNum = 0;';
line{dOS+2}=sprintf('res=[%g %g];',studyInfo.res(:));
line{dOS+3}='clrdepth=32;';
line{dOS+4}=sprintf('bgColor=[%g %g %g];',studyInfo.bgColor(:));
line{dOS+5}=sprintf('fontColor=[%g %g %g];',studyInfo.fontColor(:));
line{dOS+6}='[wPtr,wRect]=Screen(''OpenWindow'',screenNum,1,...';
line{dOS+7}='[0 0 res(1) res(2)], clrdepth);';

line{dOS+9}='InitializePsychSound(1);';
line{dOS+10}='pahandle = PsychPortAudio(''Open'', [], [], 0, freq{1}, nrchannels{1}, [], .050);';
dOS=dOS+11;

if strcmp(studyInfo.coBeInfo.questOpts,'No end question(s)')
else
    line{dOS+1}='c=1;';
    dOS=dOS+2;
end

line{dOS+1}=sprintf('%s;',studyInfo.fLine.rTrial);
dOS=dOS+2;

line{dOS+1}='for i=1:length(wavdata)';
line{dOS+2}=sprintf('trigIndex=find([%s.trigger]==trigger{i});',studyInfo.insStructName);
line{dOS+3}=sprintf('%s;',studyInfo.fLine.iTrial);
line{dOS+4}=sprintf('%s;',studyInfo.fLine.pTrial);
line{dOS+5}=sprintf('fixedSliderTrial(wPtr,wRect,bgColor,fontColor,%g,%s,trigIndex);',studyInfo.fixedSStruct.duration, studyInfo.insStructName);
line{dOS+6}=sprintf('positions{i} = stimTrial(wPtr, wRect, bgColor, fontColor, wavdata, pahandle, i, %s, trigIndex, trigger);', studyInfo.insStructName);
line{dOS+7}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',studyInfo.blankStruct.duration(2));
tabLine=[tabLine dOS+2:dOS+7];
tTabLine=[];
dOS=dOS+7;

if strcmp(studyInfo.coBeInfo.questOpts,'No end question(s)')
else
    line{dOS+1}=sprintf('if mod(i,%g)==0',studyInfo.qSettings);
    line{dOS+2}=sprintf('trigIndex=find([%s.trigger]==trigger{i});',studyInfo.qStructName);
    line{dOS+3}='rData(c).trigger=[trigger{c:i}];';
    line{dOS+4}=sprintf('qNum=%s(trigIndex).qNum;',studyInfo.qStructName);
    line{dOS+5}='for q=1:qNum';
    line{dOS+6}=sprintf('%s;',studyInfo.fLine.qTrial);
    line{dOS+7}=sprintf('rData(c).question{q}=%s(trigIndex).question{q};',studyInfo.qStructName);
    line{dOS+8}='rData(c).response{q}=res;';
    line{dOS+9}='rData(c).responseTime{q}=rTime;';
    line{dOS+10}=sprintf('blankTrial(wPtr, bgColor, fontColor, %g);',studyInfo.blankStruct.duration(1));
    line{dOS+11}='end';
    line{dOS+12}='c=c+1;';
    line{dOS+13}='end';
    tabLine=[tabLine dOS+1 dOS+13];
    dTabLine=[dTabLine dOS+2:dOS+5 dOS+11:dOS+12];
    tTabLine=[tTabLine dOS+6:dOS+10];
    dOS=dOS+13;
end

line{dOS+1}='end';

line{dOS+3}=sprintf('%s;',studyInfo.fLine.eTrial);
line{dOS+4}='PsychPortAudio(''Close'', pahandle);';
line{dOS+5}='Screen(''CloseAll'');';
line{dOS+6}='ShowCursor;';

line{dOS+8}=sprintf('path=which(''%sExp'');',studyInfo.name);
line{dOS+9}='i=find(filesep==path);';
line{dOS+10}='path=path(1:i(end));';
line{dOS+11}='dataPath=[path ''data'' filesep];';
dOS=dOS+12;

line{dOS+1}='[xC, ~] = RectCenter(wRect);';
line{dOS+2}='sL = 400;';
dOS=dOS+3;

line{dOS+1}='for w=1:length(positions)';
line{dOS+2}='for v=2:length(positions{w})';
line{dOS+3}='if positions{w}(v)<=(xC-sL)';
line{dOS+4}='positions{w}(v)=0;';
line{dOS+5}='elseif positions{w}(v)>=(xC+sL)';
line{dOS+6}='positions{w}(v)=100;';
line{dOS+7}='else';
line{dOS+8}='positions{w}(v)=(positions{w}(v)-(xC-sL))*(1./8);';
line{dOS+9}='end';
line{dOS+10}='end';
line{dOS+11}='end';
tabLine=[tabLine dOS+2 dOS+10];
dTabLine=[dTabLine dOS+3 dOS+5 dOS+7 dOS+9];
tTabLine=[tTabLine dOS+4 dOS+6 dOS+8];
dOS=dOS+12;

line{dOS+1}='cBRData = positions;';
dOS=dOS+2;

if studyInfo.presNum>1 && studyInfo.recNum>1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_R%%02d_%%d_CBR'', subject, whichPres, whichRec, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum>1 && studyInfo.recNum==1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_%%d_CBR'', subject, whichPres, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum==1 && studyInfo.recNum>1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_R%%02d_%%d_CBR'', subject, whichRec, todayDate);',studyInfo.name);
    dOS=dOS+2;
elseif studyInfo.presNum==1 && studyInfo.recNum==1
    line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_%%d_CBR'', subject, todayDate);',studyInfo.name);
    dOS=dOS+2;
end
line{dOS+1}='dataName = [dataPath name];';
line{dOS+2}='save(dataName, ''cBRData'');';
dOS=dOS+3;

if strcmp(studyInfo.coBeInfo.questOpts,'No end question(s)')
else
    if studyInfo.presNum>1 && studyInfo.recNum>1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_R%%02d_%%d_QR'', subject, whichPres, whichRec, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum>1 && studyInfo.recNum==1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_P%%02d_%%d_QR'', subject, whichPres, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum==1 && studyInfo.recNum>1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_R%%02d_%%d_QR'', subject, whichRec, todayDate);',studyInfo.name);
        dOS=dOS+2;
    elseif studyInfo.presNum==1 && studyInfo.recNum==1
        line{dOS+1}=sprintf('name=sprintf(''%s_S%%02d_%%d_QR'', subject, todayDate);',studyInfo.name);
        dOS=dOS+2;
    end
    
    line{dOS+1}='dataName = [dataPath name];';
    line{dOS+2}='save(dataName, ''rData'');';
    dOS=dOS+3;
end

studyInfo=wWriteExpLog(studyInfo);

line{dOS+1}=sprintf('%s;',studyInfo.fLine.wExpLog);

line{dOS+3}='clear all;';

studyInfo.fLine.mainExp = line{1}(10:end);

fName = sprintf('%sExp', studyInfo.name);
fID = fopen([studyInfo.path filesep fName '.m'],'w');
for i=1:length(line)
    if any(ismember(i,tabLine))
        fprintf(fID,'\t%s\n',line{i});
    elseif any(ismember(i,dTabLine))
        fprintf(fID,'\t\t%s\n',line{i});
    elseif any(ismember(i,tTabLine))
        fprintf(fID,'\t\t\t%s\n',line{i});
    else
        fprintf(fID,'%s\n',line{i});
    end
end
fclose(fID);



